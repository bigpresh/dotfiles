
# Chimera boxes use perlbrew, so switch to the right perl
export PERLBREW_ROOT=/opt/perlbrew
source $PERLBREW_ROOT/etc/bashrc
if [ -f /usr/local/chimera/perl_version ]; then
    perlbrew switch $( cat /usr/local/chimera/perl_version )
fi
export PERL5LIB=/usr/local/chimera/lib
alias cdlogs='cd /var/log/chimera/$(date +%Y/%b/%-d)'
alias cdcode='cd /usr/local/chimera'

EXTENDED_HOSTNAME_COLOR=1

function extended_hostname_color() {
    hostname=$1
    case $hostname in
        # Live boxes get a red prompt (Danger, Will Robinson!)
        *.private.uk2.net|*.us.chimera.uk2group.com|*.uk.chimera.uk2group.com)
            hostnamecolor='1;31'
        ;;
        *.dev.*)
            hostnamecolor='32'
        ;;
        *)
            echo "Unknown box type for $hostname"
        ;;
    esac
}

# Run a command on all boxes in a given Chimera environmentt
function chimerarun {
    CHIMERAENV=$1
    COMMAND=${*:2} # All params from 2nd onwards

    if [ "$CHIMERAENV" == "staging" ]; then
        echo "Running '$COMMAND' on staging boxes"
        HOSTSUFFIX="staging.chimera.uk2group.com"
    elif [ "$CHIMERAENV" == "uat" ]; then
        echo "Running '$COMMAND' on UAT boxes"
        HOSTSUFFIX="uat.chimera.uk2group.com"
    elif [ "$CHIMERAENV" == "us" ]; then
        echo "Running '$COMMAND' on $CHIMERAENV live platform"
        HOSTSUFFIX="$CHIMERAENV.chimera.uk2group.com"
    elif [ "$CHIMERAENV" == "uk" ]; then
        echo "Running '$COMMAND' on $CHIMERAENV live platform"
        HOSTSUFFIX="$CHIMERAENV.chimera.uk2group.com"
    else
        echo "Usage: chimerarun staging|us|uk|uat command"
        return
    fi

    for box in api1 api2 api3 gen; do
        echo "$box.$HOSTSUFFIX..."
        ssh -t $box.$HOSTSUFFIX "/bin/bash -l -c '$COMMAND'"
    done
}


# Convenient aliaes to SSH to UK2 boxes
function _connect_box_type() {
    type=$1
    shift
    # If the type was 'chi-live', the next arg is the location, so grab that
    # and shift
    if [ "$type" == "chi-live" ]; then
        echo "type is chi-live so grabbing location"
        location=$1;
        shift;
        echo "Location wanted is $location"
    fi

    name=$1
    shift
    fullhostname=''

    if [ "$type" = ""  -o "$name" = "" ]; then
        echo "Usage: (live|staging|uat|dev|us|uk) boxname [cmd]"
    fi

    if [[ $IMPALA_BOXES = *$name* ]]; then
        # there's no location for Impala boxes.
        case $type in
            live)
                fullhostname="$name.uk2.net"
            ;;
            staging)
                fullhostname="$name.staging.uk2.net"
            ;;
            dev)
                fullhostname="$name.dave.dev.uk2.net"
            ;;
        esac
    elif [[ "$CHIMERA_BOXES chimera" = *$name* ]]; then
        case $type in
            chi-live)
                fullhostname="$name.$location.chimera.uk2group.com"
            ;;
            staging|uat|as-live|front-end-dev)
                fullhostname="$name.$type.chimera.uk2group.com"
            ;;
            dev)
                fullhostname="chimera.dave.dev.uk2.net"
            ;;
        esac
    else
        echo "No idea what box you're talking about."
        return
    fi
    cmd="$*"
    echo -n "Connecting to $fullhostname"
    if [ "$cmd" != "" ]; then
        echo " and running $cmd..."
        ssh $fullhostname -t $cmd
    else
        echo "..."
        ssh $fullhostname
    fi
}
function live()    {
    _connect_box_type 'live' $boxname      $* 
}
function staging() { 
    _connect_box_type 'staging' $boxname   $*
}
function dev()     { 
    _connect_box_type 'dev'       $*
}
function uat()     { 
    _connect_box_type 'uat'       $*
}
function us()      {
    _connect_box_type 'chi-live' 'us' $*
}
function uk()      {
    _connect_box_type 'chi-live' 'uk' $*
}
function front-end-dev()     { 
    _connect_box_type 'front-end-dev' $*
}
function as-live()     { 
    _connect_box_type 'as-live'       $*
}



# with auto-complete for box names:
complete -W "$IMPALA_BOXES $CHIMERA_BOXES" live
complete -W "$IMPALA_BOXES $CHIMERA_BOXES" staging
complete -W "$IMPALA_BOXES $CHIMERA_BOXES chimera" dev
complete -W "$CHIMERA_BOXES" uschimeralive
complete -W "$CHIMERA_BOXES" uat
